<!-- User Message -->
<div class="chat chat-end">
    <div class="chat-bubble chat-bubble-primary">
        {{ question }}
    </div>
</div>

<!-- Assistant Message -->
<div class="chat chat-start" {% if context_warning %}data-context-warning="{{ context_warning }}"{% endif %}>
    <div
        class="chat-bubble chat-bubble-secondary bg-base-100 border border-base-200 text-base-content shadow-sm w-full max-w-4xl">
        {# Generate a unique ID for the message content #}
        {% set unique_id = message_id if message_id else (loop.index | string if loop.index else 'new-' ~ range(1, 1000)
        | random) %}

        <div class="prose max-w-none markdown-content" id="msg-content-{{ unique_id }}">
            {{ answer }}
        </div>

        <script>
            (function () {
                var uid = "{{ unique_id }}";
                var attempts = 0;
                var maxAttempts = 20; // 2 seconds

                function renderMarkdown() {
                    var targetEl = document.getElementById('msg-content-' + uid);
                    if (!targetEl) return;

                    if (typeof marked !== 'undefined' || (window.marked)) {
                        try {
                            const parse = (typeof marked !== 'undefined' ? marked.parse : window.marked.parse);
                            targetEl.innerHTML = parse(targetEl.textContent);
                        } catch (e) {
                            console.error("Markdown parsing failed:", e);
                        }
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(renderMarkdown, 100);
                    } else {
                        console.warn("Marked.js not found after 2s");
                    }
                }

                renderMarkdown();
            })();
        </script>

        {% if sources %}
        <div class="mt-3 pt-2 border-t border-base-300 text-xs">
            <p class="font-bold opacity-70 mb-1">Fuentes:</p>
            <ul class="space-y-1">
                {% for source in sources %}
                <li>
                    <button onclick="showSourceModal('{{ source.document }}', `{{ source.text }}`)"
                        class="flex gap-2 p-2 bg-base-200/50 rounded hover:bg-base-200 w-full text-left transition-colors items-center group">
                        <span class="opacity-50 group-hover:opacity-100 transition-opacity">ðŸ“„</span>
                        <div>
                            <span class="font-medium text-primary">{{ source.document }}</span>
                            <span class="opacity-70 ml-1">{{ source.location }}</span>
                        </div>
                    </button>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
</div><input type="hidden" name="conversation_id" value="{{ conversation_id }}" id="current-conversation-id" hx-swap-oob="true">
