{% for message in messages %}
<div class="flex flex-col mb-6 {{ 'items-end' if message.role == 'user' else 'items-start' }}">
    <div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-1 font-mono">
        {{ 'YOU' if message.role == 'user' else 'ASSISTANT' }}
    </div>

    {% if message.role == 'assistant' %}
    <div
        class="chat-bubble chat-bubble-info w-full max-w-4xl bg-base-100 border border-base-200 text-base-content shadow-sm">
        {% set unique_id = 'hist-' ~ message.id if message.id else 'hist-idx-' ~ loop.index %}
        <div class="prose max-w-none markdown-content" id="msg-content-{{ unique_id }}">
            {{ message.content }}
        </div>
        <script>
            (function () {
                var uid = "{{ unique_id }}";
                var attempts = 0;
                var maxAttempts = 20;

                function renderMarkdown() {
                    var targetEl = document.getElementById('msg-content-' + uid);
                    if (!targetEl) return;

                    // Check for marked availability
                    if (typeof marked !== 'undefined' || (window.marked)) {
                        try {
                            const parse = (typeof marked !== 'undefined' ? marked.parse : window.marked.parse);
                            targetEl.innerHTML = parse(targetEl.textContent);
                        } catch (e) { console.error(e); }
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(renderMarkdown, 100);
                    }
                }
                renderMarkdown();
            })();
        </script>

        {% if message.sources %}
        <div class="mt-3 pt-2 border-t border-base-300 text-xs">
            <p class="font-bold opacity-70 mb-1">Fuentes:</p>
            <ul class="space-y-1">
                {% for source in message.sources %}
                <li>
                    <button onclick="showSourceModal('{{ source.document }}', `{{ source.text }}`)"
                        class="flex gap-2 p-2 bg-base-200/50 rounded hover:bg-base-200 w-full text-left transition-colors items-center group">
                        <span class="opacity-50 group-hover:opacity-100 transition-opacity">ðŸ“„</span>
                        <div>
                            <span class="font-medium text-primary">{{ source.document }}</span>
                            <span class="opacity-70 ml-1">{{ source.location }}</span>
                        </div>
                    </button>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="chat-bubble chat-bubble-primary">
        {{ message.content }}
    </div>
    {% endif %}
</div>
{% endfor %}

{% if not messages %}
<div class="h-full flex flex-col items-center justify-center opacity-30 select-none">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
        class="w-12 h-12 mb-4">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
    </svg>
    <span class="text-xs font-mono tracking-[0.2em]">INITIALIZED</span>
</div>
{% endif %}

<!-- Helper script to set conversation ID context -->
<script>
    document.getElementById('current-conversation-id').value = "{{ conversation.id }}";
    document.getElementById('chat-title').textContent = " // {{ conversation.title | upper }}";

    // Restore document selection if provided
    {% if related_document_ids %}
    if (window.restoreDocSelection) {
        window.restoreDocSelection({{ related_document_ids| tojson }});
    }
    {% endif %}
</script>