@if (isVisible()) {
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity anime-fade-in"
    (click)="closeModal()">
    <!-- Modal Container (Matching Settings Page 'bg-panel' style) -->
    <div class="bg-panel border border-divider rounded-xl w-full max-w-xl mx-4 flex flex-col max-h-[90vh] overflow-hidden shadow-2xl anime-scale-in"
        (click)="$event.stopPropagation()">

        <!-- Header -->
        <div class="p-4 sm:p-6 border-b border-divider flex justify-between items-center bg-panel">
            <h3 class="text-lg font-semibold text-primary">Select AI Provider</h3>
            <button class="btn-icon text-secondary hover:text-primary transition-colors p-1" (click)="closeModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18" />
                    <path d="6 6 18 18" />
                </svg>
            </button>
        </div>

        <!-- Body -->
        <div class="p-6 overflow-y-auto custom-scrollbar space-y-6 flex-1">

            <!-- AI Provider Section -->
            <div>
                <div class="space-y-4">
                    <!-- Provider Selector -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Provider</label>
                        <select [ngModel]="selectedProvider()" (ngModelChange)="updateProvider($event)"
                            class="w-full px-4 py-2 bg-input border border-divider rounded-lg focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="ollama">Ollama (Local)</option>
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="groq">Groq</option>
                            <option value="lm_studio">LM Studio</option>
                            <option value="custom">Custom (OpenAI Compatible)</option>
                        </select>
                    </div>

                    <!-- Dynamic Settings based on Provider -->

                    <!-- API Keys -->
                    @if (['openai', 'anthropic', 'groq', 'custom'].includes(selectedProvider())) {
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            {{ selectedProvider() === 'openai' ? 'OpenAI API Key' :
                            (selectedProvider() === 'anthropic' ? 'Anthropic API Key' :
                            (selectedProvider() === 'groq' ? 'Groq API Key' : 'API Key (Optional)')) }}
                        </label>
                        <input type="password" [ngModel]="apiKey()" (ngModelChange)="updateApiKey($event)"
                            [placeholder]="selectedProvider() === 'groq' ? 'gsk_...' : 'sk-...'"
                            class="w-full px-4 py-2 bg-input border border-divider rounded-lg focus:outline-none focus:ring-2 focus:ring-accent">

                        @if (selectedProvider() === 'groq') {
                        <p class="text-xs text-secondary mt-1">
                            Get your key at <a href="https://console.groq.com/keys" target="_blank"
                                class="text-accent hover:underline">console.groq.com</a>
                        </p>
                        }
                    </div>
                    }

                    <!-- Base URL -->
                    @if (['ollama', 'lm_studio', 'custom'].includes(selectedProvider())) {
                    <div>
                        <label class="block text-sm font-medium mb-2">Base URL</label>
                        <input type="text" [ngModel]="baseUrl()" (ngModelChange)="updateBaseUrl($event)"
                            placeholder="http://localhost:11434"
                            class="w-full px-4 py-2 bg-input border border-divider rounded-lg focus:outline-none focus:ring-2 focus:ring-accent">

                        @if (selectedProvider() === 'custom') {
                        <p class="text-xs text-secondary mt-1">
                            Must be an OpenAI-compatible endpoint (e.g., vLLM, text-generation-webui)
                        </p>
                        }
                    </div>
                    }

                    <!-- Model Name (Manual Input) -->
                    @if (isManualModelInput()) {
                    <div>
                        <label class="block text-sm font-medium mb-2">Model Name</label>
                        <input type="text" [ngModel]="customModelId()" (ngModelChange)="updateCustomModelId($event)"
                            placeholder="e.g., mixtral-8x7b-32768"
                            class="w-full px-4 py-2 bg-input border border-divider rounded-lg focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    }

                    <!-- Models Select (Shown for Standard providers OR Groq) -->
                    @if (['ollama', 'openai', 'anthropic', 'groq'].includes(selectedProvider())) {
                    <div>
                        <label class="block text-sm font-medium mb-2">Available Models</label>

                        <select [ngModel]="selectedModel()" (ngModelChange)="updateSelectedModel($event)"
                            class="w-full px-4 py-2 bg-input border border-divider rounded-lg focus:outline-none focus:ring-2 focus:ring-accent">
                            @for (model of currentModels(); track model.name) {
                            <option [value]="model.name">
                                {{ model.name }} {{ model.vision ? ' (Vision)' : '' }}
                            </option>
                            } @empty {
                            <option disabled>No models found</option>
                            }
                        </select>
                    </div>
                    }
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-4 sm:p-6 border-t border-divider flex justify-end gap-3 bg-panel">
            <button (click)="closeModal()"
                class="px-4 py-2 rounded-lg text-sm font-medium text-secondary hover:bg-hover transition-colors">
                Cancel
            </button>
            <button (click)="saveSettings()"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-accent text-white hover:bg-accent-dark transition-colors shadow-lg shadow-accent/20">
                Save Changes
            </button>
        </div>
    </div>
</div>
}